



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="./assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.3">
    
    
      
        <title>pytest_harvest</title>
      
    
    
      <link rel="stylesheet" href="./assets/stylesheets/application.8d40d89b.css">
      
    
    
      <script src="./assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#pytest-harvest" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="pytest_harvest" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                pytest_harvest
              </span>
              <span class="md-header-nav__topic">
                Home
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/smarie/python-pytest-harvest/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    pytest_harvest
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/smarie/python-pytest-harvest/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Home
      </label>
    
    <a href="." title="Home" class="md-nav__link md-nav__link--active">
      Home
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0-prerequisite-how-to-write-session-teardown-code" title="0- Prerequisite: how to write session teardown code" class="md-nav__link">
    0- Prerequisite: how to write session teardown code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-collecting-tests-status-and-parameters" title="1- Collecting tests status and parameters" class="md-nav__link">
    1- Collecting tests status and parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-storingretrieving-fixtures" title="2- Storing/retrieving fixtures" class="md-nav__link">
    2- Storing/retrieving fixtures
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-storing-in-a-variable" title="a- Storing in a variable" class="md-nav__link">
    a- Storing in a variable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-storing-in-a-fixture" title="b- Storing in a fixture" class="md-nav__link">
    b- Storing in a fixture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-creating-results-bags-fixtures-to-collect-test-artifacts" title="3- Creating "results bags" fixtures to collect test artifacts" class="md-nav__link">
    3- Creating "results bags" fixtures to collect test artifacts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-creating-a-synthesis-table" title="4- Creating a Synthesis table" class="md-nav__link">
    4- Creating a Synthesis table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-partial-synthesis-module-function-and-synthesis-tests" title="5- Partial synthesis (module, function) and synthesis tests" class="md-nav__link">
    5- Partial synthesis (module, function) and synthesis tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-example" title="Complete example" class="md-nav__link">
    Complete example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-with-the-other-pytest-mechanisms" title="Compliance with the other pytest mechanisms" class="md-nav__link">
    Compliance with the other pytest mechanisms
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-features-benefits" title="Main features / benefits" class="md-nav__link">
    Main features / benefits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" title="See Also" class="md-nav__link">
    See Also
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#others" title="Others" class="md-nav__link">
    Others
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#want-to-contribute" title="Want to contribute ?" class="md-nav__link">
    Want to contribute ?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="changelog/" title="Changelog" class="md-nav__link">
      Changelog
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" title="Usage" class="md-nav__link">
    Usage
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#0-prerequisite-how-to-write-session-teardown-code" title="0- Prerequisite: how to write session teardown code" class="md-nav__link">
    0- Prerequisite: how to write session teardown code
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-collecting-tests-status-and-parameters" title="1- Collecting tests status and parameters" class="md-nav__link">
    1- Collecting tests status and parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-storingretrieving-fixtures" title="2- Storing/retrieving fixtures" class="md-nav__link">
    2- Storing/retrieving fixtures
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-storing-in-a-variable" title="a- Storing in a variable" class="md-nav__link">
    a- Storing in a variable
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-storing-in-a-fixture" title="b- Storing in a fixture" class="md-nav__link">
    b- Storing in a fixture
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-creating-results-bags-fixtures-to-collect-test-artifacts" title="3- Creating "results bags" fixtures to collect test artifacts" class="md-nav__link">
    3- Creating "results bags" fixtures to collect test artifacts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-creating-a-synthesis-table" title="4- Creating a Synthesis table" class="md-nav__link">
    4- Creating a Synthesis table
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-partial-synthesis-module-function-and-synthesis-tests" title="5- Partial synthesis (module, function) and synthesis tests" class="md-nav__link">
    5- Partial synthesis (module, function) and synthesis tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#complete-example" title="Complete example" class="md-nav__link">
    Complete example
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-with-the-other-pytest-mechanisms" title="Compliance with the other pytest mechanisms" class="md-nav__link">
    Compliance with the other pytest mechanisms
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main-features-benefits" title="Main features / benefits" class="md-nav__link">
    Main features / benefits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#see-also" title="See Also" class="md-nav__link">
    See Also
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#others" title="Others" class="md-nav__link">
    Others
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#want-to-contribute" title="Want to contribute ?" class="md-nav__link">
    Want to contribute ?
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/smarie/python-pytest-harvest/edit/master/docs/index.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="pytest-harvest">pytest-harvest<a class="headerlink" href="#pytest-harvest" title="Permanent link">&para;</a></h1>
<p><em>Store data created during your <code>pytest</code> tests execution, and retrieve it at the end of the session, e.g. for applicative benchmarking purposes.</em></p>
<p><a href="https://travis-ci.org/smarie/python-pytest-harvest"><img alt="Build Status" src="https://travis-ci.org/smarie/python-pytest-harvest.svg?branch=master" /></a> <a href="https://smarie.github.io/python-pytest-harvest/junit/report.html"><img alt="Tests Status" src="https://smarie.github.io/python-pytest-harvest/junit/junit-badge.svg?dummy=8484744" /></a> <a href="https://codecov.io/gh/smarie/python-pytest-harvest"><img alt="codecov" src="https://codecov.io/gh/smarie/python-pytest-harvest/branch/master/graph/badge.svg" /></a> <a href="https://smarie.github.io/python-pytest-harvest/"><img alt="Documentation" src="https://img.shields.io/badge/docs-latest-blue.svg" /></a> <a href="https://pypi.python.org/pypi/pytest_harvest/"><img alt="PyPI" src="https://img.shields.io/badge/PyPI-pytest_harvest-blue.svg" /></a></p>
<p><code>pytest</code> is a great tool to write test logic once and then generate multiple tests from <em>parameters</em>. Its <em>fixture</em> mechanism provides a cool way to inject dependencies in your tests.</p>
<p>At the end of a test session, you can already <strong>collect various data</strong> about the tests that have been run. However as opposed to <em>parameters</em> (<code>@pytest.mark.parametrize</code>), <code>pytest</code> purposedly does not keep <em>fixtures</em> (<code>@pytest.fixture</code>) in memory, because in general that would just be a waste of memory. Therefore you are currently <strong>not able to retrieve fixture values at the end of the session</strong>.</p>
<p><code>pytest-harvest</code></p>
<ul>
<li>provides a helper function to retrieve the status, duration and parameters of all tests at the end of a session, without having to register hooks</li>
<li>allows you to very easily declare that a fixture should be stored in memory until the end of the session. This unlocks many new usages ; one of them proposed in this library is to create <strong>special "result bag" fixtures</strong> to collect interesting items from your tests.</li>
</ul>
<p>With that, you can now create <strong>applicative benchmarks</strong>. For example if you have a new data science algorithm and wish to run it against several datasets, you can </p>
<ul>
<li>create a <em>test</em> that applies the algorithm on a given dataset</li>
<li><em>parametrize</em> it so that it runs against several datasets</li>
<li><strong>NEW</strong> store accuracy values in each test run thanks to a "result bag" <em>fixture</em></li>
<li><strong>NEW</strong> retrieve all accuracy values at the end of the <em>session</em> for reporting.</li>
</ul>
<p>Note: you can learn more about how to design such a benchmark in <a href="https://smarie.github.io/pytest-patterns/">pytest-patterns</a> (coming soon)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>pytest-harvest</code> has not yet been tested with pytest-xdist. See <a href="https://github.com/smarie/python-pytest-harvest/issues/1">#1</a></p>
</div>
<h2 id="installing">Installing<a class="headerlink" href="#installing" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>&gt; pip install pytest_harvest
</pre></div>


<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<p>If you "just want to see the code", jump to the <a href="#complete-example">complete example</a>. Otherwise continue from here.</p>
<h3 id="0-prerequisite-how-to-write-session-teardown-code">0- Prerequisite: how to write session teardown code<a class="headerlink" href="#0-prerequisite-how-to-write-session-teardown-code" title="Permanent link">&para;</a></h3>
<p>In order to be able to retrieve all the information that we will store, we will have to ask <code>pytest</code> to execute our retrieval/synthesis code <strong>at the end of the entire test session</strong>. <code>pytest</code> currently provides several ways to do this:</p>
<ul>
<li>through the session finish <a href="https://docs.pytest.org/en/latest/reference.html#_pytest.hookspec.pytest_sessionfinish">hook</a> (you have to write this function in the <code>conftest.py</code> file):</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">pytest_sessionfinish</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">exitstatus</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;Put here your synthesis code&gt;&quot;</span><span class="p">)</span>
</pre></div>


<ul>
<li>through a normal session-scoped fixture (put this in any of your test files or in the <code>conftest.py</code> file):</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_session_finish</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_end</span><span class="p">():</span>
        <span class="c1"># you can access the session from the injected &#39;request&#39;:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;Put here your synthesis code&gt;&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">_end</span><span class="p">)</span>
</pre></div>


<ul>
<li>through a generator (yield) session-scoped fixture (put this in any of your test files or in the <code>conftest.py</code> file):</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># Note: for pytest&lt;3.0 you have to use @pytest.yield_fixture instead</span>
<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_cooler_session_finish</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">yield</span>
    <span class="c1"># you can access the session from the injected &#39;request&#39;:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;Put here your synthesis code&gt;&quot;</span><span class="p">)</span>
</pre></div>


<p>All seem completely equivalent for the usage of <code>pytest_harvest</code>. I personally prefer the "fixture" style because you can have several of them instead of a monolithic teardown hook. Besides they can be put in the test files so I typically put them as close as possible to the tests that store the data, so as to ensure maintainability (data creation/storage and data retrieval/synthesis code are in the same file).</p>
<h3 id="1-collecting-tests-status-and-parameters">1- Collecting tests status and parameters<a class="headerlink" href="#1-collecting-tests-status-and-parameters" title="Permanent link">&para;</a></h3>
<p>Pytest already stores some information out of the box concerning tests that have run. In addition you can follow <a href="https://docs.pytest.org/en/latest/example/simple.html#making-test-result-information-available-in-fixtures">this example</a> to retrieve more, but it requires you to write a hook so it is not very convenient. </p>
<p>Instead, you can easily retrieve all of that thanks to the <code>get_session_synthesis_dct(session)</code> utility function. For example let's assume you have this parametrized test with a parametrized fixture:</p>
<div class="codehilite"><pre><span></span><span class="c1"># unparametrized fixture</span>
<span class="nd">@pytest.fixture</span>
<span class="k">def</span> <span class="nf">dummy</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;hey there !&quot;</span>

<span class="c1"># parametrized fixture</span>
<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">a_number_str</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;my_fix #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="c1"># parametrized test using the fixtures</span>
<span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a_number_str</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">a_number_str</span><span class="p">)</span>
</pre></div>


<p>When running it, 4 tests are executed:</p>
<div class="codehilite"><pre><span></span>&gt;&gt;&gt; <span class="nv">pytest</span>

<span class="o">=============================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">=============================</span>
collected <span class="m">4</span> items                                                              

path/to/test_file.py::test_foo<span class="o">[</span><span class="m">1</span>-hello<span class="o">]</span> PASSED <span class="o">[</span> <span class="m">25</span>%<span class="o">]</span>
path/to/test_file.py::test_foo<span class="o">[</span><span class="m">1</span>-world<span class="o">]</span> PASSED <span class="o">[</span> <span class="m">50</span>%<span class="o">]</span>
path/to/test_file.py::test_foo<span class="o">[</span><span class="m">2</span>-hello<span class="o">]</span> PASSED <span class="o">[</span> <span class="m">75</span>%<span class="o">]</span>
path/to/test_file.py::test_foo<span class="o">[</span><span class="m">2</span>-world<span class="o">]</span> PASSED <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">==========================</span> <span class="m">4</span> passed in <span class="m">0</span>.11 <span class="nv">seconds</span> <span class="o">===========================</span>
</pre></div>


<p>let's retrieve the available information at the end of the session (put this in your <a href="#0-prerequisite-how-to-write-session-teardown-code">session teardown</a> so that you have the session object):</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">get_session_synthesis_dct</span>
<span class="n">synth_dct</span> <span class="o">=</span> <span class="n">get_session_synthesis_dct</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">status_details</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">synth_dct</span><span class="p">))</span>
</pre></div>


<p>It yields</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[1-hello]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0010001659393310547</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span>
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.013001203536987305</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                     <span class="p">}</span>
             <span class="p">},</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[1-world]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                     <span class="p">}</span>
             <span class="p">},</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[2-hello]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0010001659393310547</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span> 
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                      <span class="p">}</span>
             <span class="p">},</span>
 <span class="s1">&#39;path/to/test_file.py::test_foo[2-world]&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;pytest_duration&#39;</span><span class="o">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s1">&#39;pytest_obj&#39;</span><span class="o">:</span> <span class="o">&lt;</span><span class="kd">function</span> <span class="nx">test_foo</span> <span class="nx">at</span> <span class="mh">0x0000000004C13B70</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_params&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;a_number_str&#39;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="o">:</span> <span class="s1">&#39;world&#39;</span><span class="p">},</span>
            <span class="s1">&#39;pytest_status&#39;</span><span class="o">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
            <span class="s1">&#39;pytest_status_details&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;call&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
                                      <span class="s1">&#39;setup&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0010001659393310547</span><span class="p">),</span>
                                      <span class="s1">&#39;teardown&#39;</span><span class="o">:</span> <span class="p">(</span><span class="s1">&#39;passed&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                                      <span class="p">}</span>
            <span class="p">},</span>
</pre></div>


<p>As you can see you get for each test node id, a dictionary containing</p>
<ul>
<li><code>'pytest_obj'</code>the object containing the test code</li>
<li><code>'pytest_status'</code> the status and <code>'pytest_duration'</code> the duration of the test</li>
<li><code>'pytest_params'</code>the parameters used in this test (both in the test function AND the fixture)</li>
<li><code>'pytest_status_details'</code> a dictionary containing the status details for each pytest internal stages: setup, call, and teardown. </li>
</ul>
<div class="admonition note">
<p class="admonition-title">status and duration aggregation</p>
<p>that the global status corresponds to an aggregation of the status of each of those stages (setup, call, teardown), but the global duration is only the duration of the "call" stage - after all we do not care about how long it took to setup and teardown.</p>
</div>
<p>Finally let's have a closer look above. It <strong>seems</strong> that after all we have collected the fixtures, right ? For example we see <code>'a_number_str': 2</code>. But beware, this is not the fixture. It is the parameter used by the fixture <code>'a_number_str'</code>. To be convinced look at its type: it is an integer, not a string! A more obvious way to confirm that the fixtures are not available, is to see that the <code>'dummy'</code> fixture does not appear at all: indeed it had no parameters.</p>
<p>To conclude: the <code>get_session_synthesis_dct(session)</code> utility function allows you to collect many information about the tests, but not the fixtures. To do that you have to use the mechanisms below.</p>
<h3 id="2-storingretrieving-fixtures">2- Storing/retrieving fixtures<a class="headerlink" href="#2-storingretrieving-fixtures" title="Permanent link">&para;</a></h3>
<p>You can either choose to store fixtures in a plain old variable, or in another, session-scoped, fixture. Both can be achieved using the same decorator <code>@saved_fixture(store)</code>.</p>
<h4 id="a-storing-in-a-variable">a- Storing in a variable<a class="headerlink" href="#a-storing-in-a-variable" title="Permanent link">&para;</a></h4>
<p>Let's create a store. It should be a dict-like object:</p>
<div class="codehilite"><pre><span></span><span class="c1"># Create a global store</span>
<span class="n">STORE</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>


<p>In order to store all created fixture values in this object, simply decorate your fixture with <code>@saved_fixture(STORE)</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">saved_fixture</span>

<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="nd">@saved_fixture</span><span class="p">(</span><span class="n">STORE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_fix</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each returned fixture value will be saved in the global store&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;my_fix #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
</pre></div>


<p>You can then retrieve the available information at the end of the session (put this in your <a href="#0-prerequisite-how-to-write-session-teardown-code">session teardown</a>):</p>
<div class="codehilite"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">STORE</span><span class="p">[</span><span class="s1">&#39;my_fix&#39;</span><span class="p">]))</span>
</pre></div>


<p>Each saved fixture appears as an ordered dictionary stored under a global key that has its name (here 'my_fix'). In this dictionary, the keys are the test node ids, and the values are the fixture values:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="s1">&#39;path/to/test_file.py::test_foo[1]&#39;</span><span class="o">:</span> <span class="s1">&#39;my_fix #1&#39;</span><span class="p">,</span> 
<span class="s1">&#39;path/to/test_file.py::test_foo[2]&#39;</span><span class="o">:</span> <span class="s1">&#39;my_fix #2&#39;</span><span class="p">}</span>
</pre></div>


<p>Note: you can change the key used in the global storage with the <code>key=</code> argument of <code>@saved_fixture</code>. </p>
<h4 id="b-storing-in-a-fixture">b- Storing in a fixture<a class="headerlink" href="#b-storing-in-a-fixture" title="Permanent link">&para;</a></h4>
<p>You might want your store to be a fixture itself, instead of a global variable. It is possible if it is session- or module-scoped (in the same module than where it is used). Simply use its name in <code>@saved_fixture</code> and it will work as expected. </p>
<p>This enables you to make the code even more readable because you can put the synthesis code in the teardown part of the storage fixture:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">saved_fixture</span>

<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="nd">@saved_fixture</span><span class="p">(</span><span class="s2">&quot;store&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">my_fix</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each returned fixture value will be saved in the global store&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;my_fix #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="c1"># -- the global storage fixture and synthesis creator --</span>
<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store</span><span class="p">():</span>
    <span class="c1"># setup: init the store</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">store</span>
    <span class="c1"># teardown: here you can collect all</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">store</span><span class="p">[</span><span class="s1">&#39;my_fix&#39;</span><span class="p">]))</span>
</pre></div>


<div class="admonition note">
<p class="admonition-title">other teardown hooks</p>
<p>If you use another teardown hook, you can still retrieve your <code>'store'</code> fixture by using the <code>get_fixture_value(request, 'store')</code> utility function provided in this library. </p>
</div>
<div class="admonition note">
<p class="admonition-title">yield_fixture</p>
<p>In old versions of pytest, you have to use <code>@pytest.yield_fixture</code> to be allowed to use <code>yield</code> in a fixture.</p>
</div>
<h3 id="3-creating-results-bags-fixtures-to-collect-test-artifacts">3- Creating "results bags" fixtures to collect test artifacts<a class="headerlink" href="#3-creating-results-bags-fixtures-to-collect-test-artifacts" title="Permanent link">&para;</a></h3>
<p>Now we are able to store fixtures. But what about the data that we create <strong>during</strong> the tests ? It can be accuracy results, etc.</p>
<p>For this, simply use <code>create_results_bag_fixture()</code> to create "results bags" fixtures where you can put any data you want:</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_harvest</span> <span class="kn">import</span> <span class="n">create_results_bag_fixture</span>

<span class="k">def</span> <span class="nf">my_algorithm</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># let&#39;s return a random accuracy !</span>
    <span class="k">return</span> <span class="n">random</span><span class="p">()</span>

<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">dataset</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;my dataset #</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

<span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&quot;algo_param&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_my_app_bench</span><span class="p">(</span><span class="n">algo_param</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">results_bag</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This test applies the algorithm with various parameters (`algo_param`)</span>
<span class="sd">    on various datasets (`dataset`). Accuracies are stored in a results</span>
<span class="sd">    bag (`results_bag`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># apply the algorithm with param `algo_param` on dataset `dataset`</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">my_algorithm</span><span class="p">(</span><span class="n">algo_param</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
    <span class="c1"># store it in the results bag</span>
    <span class="n">results_bag</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy</span>

<span class="c1"># -- the results bag fixture --</span>
<span class="c1"># note: depending on your pytest version, the name used by pytest might be</span>
<span class="c1"># the variable name (left) or the one you provide in the &#39;name&#39; argument so </span>
<span class="c1"># make sure they are identical! </span>
<span class="n">results_bag</span> <span class="o">=</span> <span class="n">create_results_bag_fixture</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;results_bag&quot;</span><span class="p">)</span>

<span class="c1"># -- the global storage fixture and synthesis creator --</span>
<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c1"># setup: init the store</span>
    <span class="n">store</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">store</span>
    <span class="c1"># teardown: here you can collect all</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">store</span><span class="p">[</span><span class="s1">&#39;results_bag&#39;</span><span class="p">]))</span>
</pre></div>


<p>We can see the correct results collected:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[A-1]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.2630766637159053</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[A-2]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.6720533462346249</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[B-1]&#39;</span><span class="o">:</span>
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.9121353916881674</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[B-2]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.9401074040573346</span><span class="p">},</span> 
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[C-1]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.01619034700438804</span><span class="p">},</span>
<span class="s1">&#39;path/to/test_file.py::::test_my_app_bench[C-2]&#39;</span><span class="o">:</span> 
     <span class="nx">ResultsBag</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;accuracy&#39;</span><span class="o">:</span> <span class="mf">0.8027244886806986</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>We can of course combine this with the test status and parameters (we saw <a href="#1-collecting-tests-status-and-parameters">above</a> how to collect them) if we want to create a synthesis table. This complete story will be available on <a href="https://github.com/smarie/pytest-patterns">pytest-patterns</a>.</p>
<div class="admonition note">
<p class="admonition-title">results bag fixtures' storage</p>
<p>You declare the storage used in the arguments of <code>create_results_bag_fixture</code>. As this relies on <code>@saved_fixture</code>, you can use both a variable or a session/module-scoped fixture name as we saw in previous chapter. </p>
</div>
<h3 id="4-creating-a-synthesis-table">4- Creating a Synthesis table<a class="headerlink" href="#4-creating-a-synthesis-table" title="Permanent link">&para;</a></h3>
<p>Now that we know</p>
<ul>
<li>how to retrieve pytest status and parameters</li>
<li>how to store and retrieve fixtures</li>
<li>and how to store and retrieve applicative results</li>
</ul>
<p>We can create a synthesis table containing all information available. This is very easy: instead of calling <code>get_session_synthesis_dct</code> with no parameters, give it your <code>store</code> object. Since we want to create a table, we will use the <code>flatten</code> and <code>flatten_more</code> options so that the result does not contain nested dictionaries for the parameters, fixtures, and result bags. Finally we decide that we want the durations expressed in ms (pytest measures them in seconds by default).</p>
<div class="codehilite"><pre><span></span><span class="c1"># retrieve the synthesis, merged with the fixture store</span>
<span class="n">results_dct</span> <span class="o">=</span> <span class="n">get_session_synthesis_dct</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">fixture_store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> 
                                        <span class="n">flatten</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">flatten_more</span><span class="o">=</span><span class="s1">&#39;results_bag&#39;</span><span class="p">,</span>
                                        <span class="n">durations_in_ms</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>We can print the first entry:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">results_dct</span><span class="o">.</span><span class="n">values</span><span class="p">()))))</span>

<span class="p">{</span><span class="s1">&#39;pytest_obj&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">test_my_app_bench</span> <span class="n">at</span> <span class="mh">0x0000000004FF6A60</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="s1">&#39;pytest_status&#39;</span><span class="p">:</span> <span class="s1">&#39;passed&#39;</span><span class="p">,</span>
 <span class="s1">&#39;pytest_duration_ms&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
 <span class="s1">&#39;dataset&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
 <span class="s1">&#39;algo_param&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
 <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="mf">0.2630766637159053</span><span class="p">}</span>
</pre></div>


<p>We see that all information is available at the same level: pytest status and duration, parameters (<code>dataset</code> and <code>algo_param</code>), and results (<code>accuracy</code>).</p>
<p>Transforming such a flattened dictionary in a table is very easy with <code>pandas</code>:</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">results_dct</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
<span class="c1"># (a) remove the full test id path</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">results_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">()</span> \
                             <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">test_id</span><span class="p">:</span> <span class="n">test_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># (b) drop pytest object column</span>
<span class="n">results_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;pytest_obj&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>And finally we can use <code>pandas</code> or <code>tabulate</code> to export the result in csv or markdown format:</p>
<div class="codehilite"><pre><span></span><span class="c1"># csv format</span>
<span class="k">print</span><span class="p">(</span><span class="n">results_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">())</span>

<span class="c1"># github markdown format</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="k">print</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="n">results_df</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s1">&#39;keys&#39;</span><span class="p">))</span>
</pre></div>


<table>
<thead>
<tr>
<th></th>
<th>status</th>
<th>duration_ms</th>
<th>algo_param</th>
<th>dataset</th>
<th>accuracy</th>
</tr>
</thead>
<tbody>
<tr>
<td>test_my_app_bench[A-1]</td>
<td>passed</td>
<td>1.00017</td>
<td>1</td>
<td>A</td>
<td>0.313807</td>
</tr>
<tr>
<td>test_my_app_bench[A-2]</td>
<td>passed</td>
<td>0</td>
<td>2</td>
<td>A</td>
<td>0.0459802</td>
</tr>
<tr>
<td>test_my_app_bench[B-1]</td>
<td>passed</td>
<td>0</td>
<td>1</td>
<td>B</td>
<td>0.638511</td>
</tr>
<tr>
<td>test_my_app_bench[B-2]</td>
<td>passed</td>
<td>0</td>
<td>2</td>
<td>B</td>
<td>0.10418</td>
</tr>
<tr>
<td>test_my_app_bench[C-1]</td>
<td>passed</td>
<td>0</td>
<td>1</td>
<td>C</td>
<td>0.287151</td>
</tr>
<tr>
<td>test_my_app_bench[C-2]</td>
<td>passed</td>
<td>0</td>
<td>2</td>
<td>C</td>
<td>0.19437</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Duration calculation</p>
<p>The duration field is directly extracted from <code>pytest</code>. Currently <code>pytest</code> computes durations using the <code>time</code> method, which might not be as accurate as other methods - see opened discussion <a href="https://github.com/pytest-dev/pytest/issues/4391">here</a>. If you need more precise duration benchmarking <strong>now</strong>, of if you need to measure the duration of a specific sub-function instead of the duration of the whole test function call, use <a href="https://github.com/ionelmc/pytest-benchmark">pytest-benchmark</a>. In the long run, the author thinks that <code>pytest</code> will hopefully provide more precise duration estimates, and therefore you will be able to get similar results in the table outputted above (+ possibly a <code>@repeat(n)</code> parameter on top of your test function if you wish to repeat it several times and compare the durations).</p>
</div>
<h3 id="5-partial-synthesis-module-function-and-synthesis-tests">5- Partial synthesis (module, function) and synthesis tests<a class="headerlink" href="#5-partial-synthesis-module-function-and-synthesis-tests" title="Permanent link">&para;</a></h3>
<p>We have seen <a href="#1-collecting-tests-status-and-parameters">above</a> that you can get the pytest <code>session</code> object from many different teardown hooks. In addition, you can even access it from inside a test! In that case all information will not be available, but if the synthesis test is located <strong>after</strong> the test function of interest in execution order, it will be ok.</p>
<p>To be sure to only get results you're interested in, the special <code>filter</code> argument allows you to only select parts of the test nodes to create the synthesis:</p>
<div class="codehilite"><pre><span></span><span class="c1"># a module-scoped store</span>
<span class="nd">@pytest.fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">store</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

<span class="c1"># results bag fixture</span>
<span class="n">my_results</span> <span class="o">=</span> <span class="n">create_results_bag_fixture</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;my_results&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_foo</span><span class="p">(</span><span class="n">my_results</span><span class="p">):</span>
    <span class="o">...</span>

<span class="k">def</span> <span class="nf">test_synthesis</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">store</span><span class="p">):</span>
    <span class="c1"># get partial results concerning `test_foo`</span>
    <span class="n">results_dct</span> <span class="o">=</span> <span class="n">get_session_synthesis_dct</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">test_foo</span><span class="p">,</span> 
                                            <span class="n">fixture_store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>

    <span class="c1"># you can assert / report using the `results_dct` here</span>
</pre></div>


<p>See <code>help(get_session_synthesis_dct)</code> for details: for example you can include in this filter a list, and it can contain module names too.</p>
<h3 id="complete-example">Complete example<a class="headerlink" href="#complete-example" title="Permanent link">&para;</a></h3>
<p>A module-scoped complete example with parameters, fixtures, and results bag can be found <a href="https://github.com/smarie/python-pytest-harvest/tree/master/pytest_harvest/tests_raw/test_doc_example.py">here</a>.</p>
<h3 id="compliance-with-the-other-pytest-mechanisms">Compliance with the other pytest mechanisms<a class="headerlink" href="#compliance-with-the-other-pytest-mechanisms" title="Permanent link">&para;</a></h3>
<p>This package solely relies on the fixtures mechanism and the <code>pytest_runtest_makereport</code> hook. It should therefore be quite portable across pytest versions.</p>
<h2 id="main-features-benefits">Main features / benefits<a class="headerlink" href="#main-features-benefits" title="Permanent link">&para;</a></h2>
<ul>
<li>
<p><strong>Collect test execution information easily</strong>: with <code>get_session_synthesis_dct(session)</code> you can get a lot of information about tests, without the hassle of writing hooks. </p>
</li>
<li>
<p><strong>Store selected fixtures declaratively</strong>: simply decorate your fixture with <code>@saved_fixture(storage)</code> and all fixture values will be stored in the selected storage (a variable or another fixture).</p>
</li>
<li>
<p><strong>Collect test artifacts</strong>: you can create "results bags" fixtures to store applicative information during your tests and retrieve it at the end. It makes it very easy to create applicative benchmarks, for example for data science.</p>
</li>
<li>
<p><strong>Highly configurable</strong>: storage object (for storing fixtures) or results bag object (for collecting results from tests) can be any object type of your choice. For results bags, a default type is provided that behaves like a "munch" (both a dictionary and an object).</p>
</li>
</ul>
<h2 id="see-also">See Also<a class="headerlink" href="#see-also" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://docs.pytest.org/en/latest/parametrize.html">pytest documentation on parametrize</a></li>
<li><a href="https://docs.pytest.org/en/latest/fixture.html">pytest documentation on fixtures</a></li>
<li><a href="https://smarie.github.io/pytest-patterns/">pytest-patterns</a>, to go further and create for example a data science benchmark by combining this plugin with others.</li>
</ul>
<h3 id="others">Others<a class="headerlink" href="#others" title="Permanent link">&para;</a></h3>
<p><em>Do you like this library ? You might also like <a href="https://github.com/smarie/OVERVIEW#python">my other python libraries</a></em> </p>
<h2 id="want-to-contribute">Want to contribute ?<a class="headerlink" href="#want-to-contribute" title="Permanent link">&para;</a></h2>
<p>Details on the github page: <a href="https://github.com/smarie/python-pytest-harvest">https://github.com/smarie/python-pytest-harvest</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
        
          <a href="changelog/" title="Changelog" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Changelog
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./assets/javascripts/application.b438e6c5.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"."}})</script>
      
    
    
      
    
  </body>
</html>